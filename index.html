import React, { useState, useEffect } from 'react';
import { Calendar, Users, Clock, Settings, BarChart3, User, Plus, Minus, ChevronLeft, ChevronRight, Check, X, Edit, Save, AlertCircle } from 'lucide-react';

const CatholicReaderSystem = () => {
  // 상태 관리
  const [currentUser, setCurrentUser] = useState({ id: 1, name: '관리자', role: 'admin' });
  const [activeTab, setActiveTab] = useState('schedule');
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  
  // 기본 데이터
  const [masses, setMasses] = useState([
    { id: 1, day: 0, time: '06:00', type: '새벽미사', readingCount: 1 }, // 일요일
    { id: 2, day: 0, time: '09:00', type: '주일미사', readingCount: 2 },
    { id: 3, day: 0, time: '11:00', type: '주일미사', readingCount: 2 },
    { id: 4, day: 6, time: '19:00', type: '토요일미사', readingCount: 2 }, // 토요일
    { id: 5, day: 1, time: '06:30', type: '평일미사', readingCount: 1 }, // 월요일
    { id: 6, day: 2, time: '06:30', type: '평일미사', readingCount: 1 }, // 화요일
    { id: 7, day: 3, time: '06:30', type: '평일미사', readingCount: 1 }, // 수요일
    { id: 8, day: 4, time: '06:30', type: '평일미사', readingCount: 1 }, // 목요일
    { id: 9, day: 5, time: '06:30', type: '평일미사', readingCount: 1 }, // 금요일
  ]);

  const [readers, setReaders] = useState([
    { id: 1, name: '김요한', gender: '남', isCouple: true, coupleId: 2, serviceCount: 0 },
    { id: 2, name: '김마리아', gender: '여', isCouple: true, coupleId: 1, serviceCount: 0 },
    { id: 3, name: '박베드로', gender: '남', isCouple: false, coupleId: null, serviceCount: 0 },
    { id: 4, name: '이안나', gender: '여', isCouple: false, coupleId: null, serviceCount: 0 },
    { id: 5, name: '최바오로', gender: '남', isCouple: true, coupleId: 6, serviceCount: 0 },
    { id: 6, name: '최엘리사벳', gender: '여', isCouple: true, coupleId: 5, serviceCount: 0 },
    { id: 7, name: '정요셉', gender: '남', isCouple: false, coupleId: null, serviceCount: 0 },
    { id: 8, name: '한루시아', gender: '여', isCouple: false, coupleId: null, serviceCount: 0 },
  ]);

  const [unavailability, setUnavailability] = useState({});
  const [assignments, setAssignments] = useState({});
  const [showMassForm, setShowMassForm] = useState(false);
  const [showReaderForm, setShowReaderForm] = useState(false);
  const [editingMass, setEditingMass] = useState(null);
  const [editingReader, setEditingReader] = useState(null);
  const [massForm, setMassForm] = useState({ day: 0, time: '', type: '', readingCount: 1 });
  const [readerForm, setReaderForm] = useState({ name: '', gender: '남', isCouple: false, coupleId: null });

  // 날짜 관련 유틸리티
  const getDaysInMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  };

  const getFirstDayOfMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  };

  const formatDate = (date) => {
    return date.toISOString().split('T')[0];
  };

  const getDateString = (year, month, day) => {
    return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  };

  // 미사 일정 생성
  const generateMassSchedule = (year, month) => {
    const schedule = [];
    const daysInMonth = getDaysInMonth(new Date(year, month));
    
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay();
      
      masses.forEach(mass => {
        if (mass.day === dayOfWeek) {
          const dateStr = getDateString(year, month, day);
          schedule.push({
            date: dateStr,
            massId: mass.id,
            time: mass.time,
            type: mass.type,
            readingCount: mass.readingCount,
            dayOfWeek
          });
        }
      });
    }
    
    return schedule;
  };

  // 독서 배정 알고리즘
  const autoAssignReaders = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const schedule = generateMassSchedule(year, month);
    const newAssignments = {};
    
    // 독서자별 봉사 횟수 초기화
    const serviceCountByReader = {};
    readers.forEach(reader => {
      serviceCountByReader[reader.id] = reader.serviceCount;
    });

    // 토요일 배정자 추적
    const saturdayAssigned = new Set();

    schedule.forEach(mass => {
      const { date, massId, readingCount, dayOfWeek } = mass;
      const key = `${date}-${massId}`;
      
      // 해당 날짜에 불가능한 독서자 필터링
      const availableReaders = readers.filter(reader => {
        const unavailableKey = `${reader.id}-${date}-${massId}`;
        const isUnavailable = unavailability[unavailableKey];
        
        // 토요일 저녁 미사 배정자는 일요일 제외
        if (dayOfWeek === 0 && saturdayAssigned.has(reader.id)) {
          return false;
        }
        
        return !isUnavailable;
      });

      const assignment = { first: null, second: null };

      if (readingCount === 1) {
        // 1독서만 있는 경우 (남녀 모두 가능)
        const sortedReaders = availableReaders.sort((a, b) => 
          serviceCountByReader[a.id] - serviceCountByReader[b.id]
        );
        
        if (sortedReaders.length > 0) {
          assignment.first = sortedReaders[0].id;
          serviceCountByReader[sortedReaders[0].id]++;
          
          // 토요일 저녁 미사인 경우 기록
          if (dayOfWeek === 6 && mass.time === '19:00') {
            saturdayAssigned.add(sortedReaders[0].id);
          }
        }
      } else if (readingCount === 2) {
        // 1독서: 남성, 2독서: 여성
        const maleReaders = availableReaders.filter(r => r.gender === '남');
        const femaleReaders = availableReaders.filter(r => r.gender === '여');
        
        // 부부독서단 우선 고려
        const couples = availableReaders
          .filter(r => r.isCouple)
          .reduce((acc, reader) => {
            if (!acc[reader.coupleId]) acc[reader.coupleId] = [];
            acc[reader.coupleId].push(reader);
            return acc;
          }, {});

        let assigned = false;

        // 부부독서단 배정 시도
        Object.values(couples).forEach(couple => {
          if (assigned || couple.length !== 2) return;
          
          const husband = couple.find(r => r.gender === '남');
          const wife = couple.find(r => r.gender === '여');
          
          if (husband && wife) {
            assignment.first = husband.id;
            assignment.second = wife.id;
            serviceCountByReader[husband.id]++;
            serviceCountByReader[wife.id]++;
            assigned = true;
            
            // 토요일 저녁 미사인 경우 기록
            if (dayOfWeek === 6 && mass.time === '19:00') {
              saturdayAssigned.add(husband.id);
              saturdayAssigned.add(wife.id);
            }
          }
        });

        // 부부독서단으로 배정되지 않은 경우 개별 배정
        if (!assigned) {
          const sortedMales = maleReaders.sort((a, b) => 
            serviceCountByReader[a.id] - serviceCountByReader[b.id]
          );
          const sortedFemales = femaleReaders.sort((a, b) => 
            serviceCountByReader[a.id] - serviceCountByReader[b.id]
          );

          if (sortedMales.length > 0) {
            assignment.first = sortedMales[0].id;
            serviceCountByReader[sortedMales[0].id]++;
            
            // 토요일 저녁 미사인 경우 기록
            if (dayOfWeek === 6 && mass.time === '19:00') {
              saturdayAssigned.add(sortedMales[0].id);
            }
          }

          if (sortedFemales.length > 0) {
            assignment.second = sortedFemales[0].id;
            serviceCountByReader[sortedFemales[0].id]++;
            
            // 토요일 저녁 미사인 경우 기록
            if (dayOfWeek === 6 && mass.time === '19:00') {
              saturdayAssigned.add(sortedFemales[0].id);
            }
          }
        }
      }

      newAssignments[key] = assignment;
    });

    // 독서자 봉사 횟수 업데이트
    const updatedReaders = readers.map(reader => ({
      ...reader,
      serviceCount: serviceCountByReader[reader.id]
    }));
    
    setReaders(updatedReaders);
    setAssignments(newAssignments);
  };

  // 달력 렌더링
  const renderCalendar = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const daysInMonth = getDaysInMonth(currentDate);
    const firstDay = getFirstDayOfMonth(currentDate);
    const schedule = generateMassSchedule(year, month);
    
    const days = [];
    const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
    
    // 요일 헤더
    dayNames.forEach(day => {
      days.push(
        <div key={day} className="p-2 text-center font-bold text-gray-700 bg-blue-50">
          {day}
        </div>
      );
    });

    // 빈 셀 (월 시작 전)
    for (let i = 0; i < firstDay; i++) {
      days.push(<div key={`empty-${i}`} className="p-2 bg-gray-50"></div>);
    }

    // 날짜 셀
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = getDateString(year, month, day);
      const dayMasses = schedule.filter(s => s.date === dateStr);
      
      days.push(
        <div 
          key={day} 
          className="p-2 border min-h-[120px] cursor-pointer hover:bg-blue-50"
          onClick={() => setSelectedDate(dateStr)}
        >
          <div className="font-semibold mb-1">{day}</div>
          {dayMasses.map((mass, idx) => {
            const assignmentKey = `${dateStr}-${mass.massId}`;
            const assignment = assignments[assignmentKey];
            const hasAssignment = assignment && (assignment.first || assignment.second);
            
            return (
              <div 
                key={idx} 
                className={`text-xs p-1 mb-1 rounded ${
                  hasAssignment ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
                }`}
              >
                {mass.time} {mass.type}
                {hasAssignment && (
                  <div className="text-xs">
                    {assignment.first && readers.find(r => r.id === assignment.first)?.name}
                    {assignment.second && `, ${readers.find(r => r.id === assignment.second)?.name}`}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      );
    }

    return days;
  };

  // 불가능 시간 토글
  const toggleUnavailability = (readerId, date, massId) => {
    const key = `${readerId}-${date}-${massId}`;
    setUnavailability(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  // 미사 일정 저장
  const saveMass = () => {
    console.log('saveMass 함수 실행, massForm:', massForm);
    
    // 유효성 검사
    if (!massForm.time || !massForm.type) {
      alert('시간과 미사 구분을 모두 입력해주세요.');
      return;
    }

    if (editingMass) {
      console.log('미사 일정 수정 모드');
      setMasses(prev => prev.map(m => 
        m.id === editingMass.id ? { ...massForm, id: editingMass.id } : m
      ));
      setEditingMass(null);
    } else {
      console.log('새 미사 일정 추가 모드');
      const newId = Math.max(...masses.map(m => m.id), 0) + 1;
      const newMass = { ...massForm, id: newId };
      console.log('새로 추가할 미사:', newMass);
      setMasses(prev => {
        const updated = [...prev, newMass];
        console.log('업데이트된 미사 목록:', updated);
        return updated;
      });
    }
    
    // 폼 초기화
    setMassForm({ day: 0, time: '', type: '', readingCount: 1 });
    setShowMassForm(false);
  };

  // 독서단원 저장
  const saveReader = () => {
    console.log('saveReader 함수 실행, readerForm:', readerForm);
    
    // 유효성 검사
    if (!readerForm.name.trim()) {
      alert('이름을 입력해주세요.');
      return;
    }

    if (editingReader) {
      console.log('독서단원 수정 모드');
      setReaders(prev => prev.map(r => 
        r.id === editingReader.id ? { ...readerForm, id: editingReader.id, serviceCount: editingReader.serviceCount } : r
      ));
      setEditingReader(null);
    } else {
      console.log('새 독서단원 추가 모드');
      const newId = Math.max(...readers.map(r => r.id), 0) + 1;
      const newReader = { ...readerForm, id: newId, serviceCount: 0 };
      console.log('새로 추가할 독서단원:', newReader);
      
      setReaders(prev => {
        let updated = [...prev, newReader];
        
        // 부부독서단인 경우 상대방 정보도 업데이트
        if (readerForm.isCouple && readerForm.coupleId) {
          updated = updated.map(r => 
            r.id === readerForm.coupleId 
              ? { ...r, isCouple: true, coupleId: newId }
              : r
          );
        }
        
        console.log('업데이트된 독서단원 목록:', updated);
        return updated;
      });
    }
    
    // 폼 초기화
    setReaderForm({ name: '', gender: '남', isCouple: false, coupleId: null });
    setShowReaderForm(false);
  };

  // 편집 시작
  const startEditMass = (mass) => {
    setMassForm(mass);
    setEditingMass(mass);
    setShowMassForm(true);
  };

  const startEditReader = (reader) => {
    setReaderForm(reader);
    setEditingReader(reader);
    setShowReaderForm(true);
  };

  // 미사 일정 관리 컴포넌트
  const MassScheduleManager = () => (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h3 className="text-xl font-bold">미사 일정 관리</h3>
        <button
          onClick={() => {
            console.log('미사 일정 추가 버튼 클릭');
            setMassForm({ day: 0, time: '', type: '', readingCount: 1 });
            setEditingMass(null);
            setShowMassForm(true);
          }}
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"
        >
          <Plus size={16} />
          미사 일정 추가
        </button>
      </div>

      <div className="grid gap-4">
        {masses.map(mass => (
          <div key={mass.id} className="bg-white p-4 rounded-lg border">
            <div className="flex justify-between items-center">
              <div>
                <div className="font-semibold">
                  {['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'][mass.day]} {mass.time}
                </div>
                <div className="text-gray-600">{mass.type} - {mass.readingCount}독서</div>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => startEditMass(mass)}
                  className="text-blue-600 hover:text-blue-800"
                >
                  <Edit size={16} />
                </button>
                <button
                  onClick={() => setMasses(masses.filter(m => m.id !== mass.id))}
                  className="text-red-600 hover:text-red-800"
                >
                  <X size={16} />
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  // 미사 일정 폼 컴포넌트
  const MassForm = () => {
    const handleSubmit = (e) => {
      e.preventDefault();
      console.log('폼 제출, 현재 massForm:', massForm);
      saveMass();
    };

    const handleClose = () => {
      console.log('폼 닫기');
      setShowMassForm(false);
      setEditingMass(null);
      setMassForm({ day: 0, time: '', type: '', readingCount: 1 });
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white p-6 rounded-lg max-w-md w-full m-4">
          <h3 className="text-lg font-bold mb-4">
            {editingMass ? '미사 일정 수정' : '미사 일정 추가'}
          </h3>
          
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">요일</label>
              <select
                value={massForm.day}
                onChange={(e) => {
                  const newDay = parseInt(e.target.value);
                  console.log('요일 변경:', newDay);
                  setMassForm(prev => ({...prev, day: newDay}));
                }}
                className="w-full border rounded-lg px-3 py-2 text-base"
              >
                <option value={0}>일요일</option>
                <option value={1}>월요일</option>
                <option value={2}>화요일</option>
                <option value={3}>수요일</option>
                <option value={4}>목요일</option>
                <option value={5}>금요일</option>
                <option value={6}>토요일</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-medium mb-1">시간</label>
              <input
                type="time"
                value={massForm.time}
                onChange={(e) => {
                  console.log('시간 변경:', e.target.value);
                  setMassForm(prev => ({...prev, time: e.target.value}));
                }}
                className="w-full border rounded-lg px-3 py-2 text-base"
                required
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium mb-1">미사 구분</label>
              <input
                type="text"
                value={massForm.type}
                onChange={(e) => {
                  console.log('미사 구분 변경:', e.target.value);
                  setMassForm(prev => ({...prev, type: e.target.value}));
                }}
                placeholder="예: 주일미사, 평일미사"
                className="w-full border rounded-lg px-3 py-2 text-base"
                required
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium mb-1">독서 수</label>
              <select
                value={massForm.readingCount}
                onChange={(e) => {
                  const newCount = parseInt(e.target.value);
                  console.log('독서 수 변경:', newCount);
                  setMassForm(prev => ({...prev, readingCount: newCount}));
                }}
                className="w-full border rounded-lg px-3 py-2 text-base"
              >
                <option value={1}>1독서</option>
                <option value={2}>2독서</option>
              </select>
            </div>
            
            <div className="flex justify-end gap-2 mt-6">
              <button
                type="button"
                onClick={handleClose}
                className="px-4 py-2 border rounded-lg hover:bg-gray-50 text-base"
              >
                취소
              </button>
              <button
                type="submit"
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-base"
              >
                저장
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  // 독서단원 폼 컴포넌트
  const ReaderForm = () => {
    const availablePartners = readers.filter(r => 
      r.gender !== readerForm.gender && !r.isCouple && r.id !== editingReader?.id
    );

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white p-6 rounded-lg max-w-md w-full m-4">
          <h3 className="text-lg font-bold mb-4">
            {editingReader ? '독서단원 수정' : '독서단원 추가'}
          </h3>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">이름</label>
              <input
                type="text"
                value={readerForm.name}
                onChange={(e) => setReaderForm({...readerForm, name: e.target.value})}
                className="w-full border rounded-lg px-3 py-2"
                placeholder="이름을 입력하세요"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium mb-1">성별</label>
              <select
                value={readerForm.gender}
                onChange={(e) => setReaderForm({...readerForm, gender: e.target.value})}
                className="w-full border rounded-lg px-3 py-2"
              >
                <option value="남">남성</option>
                <option value="여">여성</option>
              </select>
            </div>
            
            <div>
              <label className="flex items-center gap-2">
                <input
                  type="checkbox"
                  checked={readerForm.isCouple}
                  onChange={(e) => setReaderForm({
                    ...readerForm, 
                    isCouple: e.target.checked,
                    coupleId: e.target.checked ? readerForm.coupleId : null
                  })}
                />
                부부독서단
              </label>
            </div>
            
            {readerForm.isCouple && (
              <div>
                <label className="block text-sm font-medium mb-1">배우자</label>
                <select
                  value={readerForm.coupleId || ''}
                  onChange={(e) => setReaderForm({...readerForm, coupleId: parseInt(e.target.value) || null})}
                  className="w-full border rounded-lg px-3 py-2"
                >
                  <option value="">배우자 선택</option>
                  {availablePartners.map(partner => (
                    <option key={partner.id} value={partner.id}>
                      {partner.name}
                    </option>
                  ))}
                </select>
              </div>
            )}
          </div>
          
          <div className="flex justify-end gap-2 mt-6">
            <button
              onClick={() => {
                setShowReaderForm(false);
                setEditingReader(null);
                setReaderForm({ name: '', gender: '남', isCouple: false, coupleId: null });
              }}
              className="px-4 py-2 border rounded-lg hover:bg-gray-50"
            >
              취소
            </button>
            <button
              onClick={saveReader}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              저장
            </button>
          </div>
        </div>
      </div>
    );
  };

  // 독서자 관리 컴포넌트
  const ReaderManager = () => (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h3 className="text-xl font-bold">독서단원 관리</h3>
        <button
          onClick={() => {
            console.log('독서단원 추가 버튼 클릭');
            setReaderForm({ name: '', gender: '남', isCouple: false, coupleId: null });
            setEditingReader(null);
            setShowReaderForm(true);
          }}
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"
        >
          <Plus size={16} />
          독서단원 추가
        </button>
      </div>

      <div className="grid gap-4">
        {readers.map(reader => (
          <div key={reader.id} className="bg-white p-4 rounded-lg border">
            <div className="flex justify-between items-center">
              <div>
                <div className="font-semibold flex items-center gap-2">
                  {reader.name} ({reader.gender})
                  {reader.isCouple && (
                    <span className="bg-pink-100 text-pink-800 px-2 py-1 rounded text-xs">
                      부부독서단
                    </span>
                  )}
                </div>
                <div className="text-gray-600">봉사 횟수: {reader.serviceCount}회</div>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => startEditReader(reader)}
                  className="text-blue-600 hover:text-blue-800"
                >
                  <Edit size={16} />
                </button>
                <button
                  onClick={() => setReaders(readers.filter(r => r.id !== reader.id))}
                  className="text-red-600 hover:text-red-800"
                >
                  <X size={16} />
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  // 불가능 시간 입력 컴포넌트
  const UnavailabilityInput = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const schedule = generateMassSchedule(year, month);
    
    return (
      <div className="space-y-6">
        <h3 className="text-xl font-bold">불가능 시간 입력</h3>
        
        {currentUser.role === 'reader' ? (
          // 개별 독서자 화면
          <div className="space-y-4">
            {schedule.map(mass => {
              const key = `${currentUser.id}-${mass.date}-${mass.massId}`;
              const isUnavailable = unavailability[key];
              
              return (
                <div key={`${mass.date}-${mass.massId}`} className="bg-white p-4 rounded-lg border">
                  <div className="flex justify-between items-center">
                    <div>
                      <div className="font-semibold">{mass.date}</div>
                      <div className="text-gray-600">{mass.time} {mass.type}</div>
                    </div>
                    <button
                      onClick={() => toggleUnavailability(currentUser.id, mass.date, mass.massId)}
                      className={`px-4 py-2 rounded-lg ${
                        isUnavailable 
                          ? 'bg-red-100 text-red-800' 
                          : 'bg-green-100 text-green-800'
                      }`}
                    >
                      {isUnavailable ? '불가능' : '가능'}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          // 관리자 화면 - 모든 독서자의 불가능 시간 확인
          <div className="space-y-4">
            {readers.map(reader => (
              <div key={reader.id} className="bg-white p-4 rounded-lg border">
                <h4 className="font-semibold mb-3">{reader.name}</h4>
                <div className="grid gap-2">
                  {schedule.slice(0, 10).map(mass => {
                    const key = `${reader.id}-${mass.date}-${mass.massId}`;
                    const isUnavailable = unavailability[key];
                    
                    return (
                      <div key={`${mass.date}-${mass.massId}`} className="flex justify-between items-center text-sm">
                        <span>{mass.date} {mass.time} {mass.type}</span>
                        <span className={isUnavailable ? 'text-red-600' : 'text-green-600'}>
                          {isUnavailable ? '불가능' : '가능'}
                        </span>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    );
  };

  // 통계 컴포넌트
  const Statistics = () => (
    <div className="space-y-6">
      <h3 className="text-xl font-bold">봉사 통계</h3>
      
      <div className="grid gap-4">
        <div className="bg-white p-6 rounded-lg border">
          <h4 className="font-semibold mb-4">독서자별 봉사 횟수</h4>
          <div className="space-y-3">
            {readers
              .sort((a, b) => b.serviceCount - a.serviceCount)
              .map(reader => (
                <div key={reader.id} className="flex justify-between items-center">
                  <span className="font-medium">{reader.name}</span>
                  <div className="flex items-center gap-4">
                    <div className="w-32 bg-gray-200 rounded-full h-3">
                      <div 
                        className="bg-blue-600 h-3 rounded-full" 
                        style={{
                          width: `${Math.max(10, (reader.serviceCount / Math.max(...readers.map(r => r.serviceCount), 1)) * 100)}%`
                        }}
                      ></div>
                    </div>
                    <span className="font-bold text-blue-600">{reader.serviceCount}회</span>
                  </div>
                </div>
              ))}
          </div>
        </div>

        <div className="bg-white p-6 rounded-lg border">
          <h4 className="font-semibold mb-4">부부독서단 현황</h4>
          <div className="space-y-2">
            {readers
              .filter(r => r.isCouple)
              .reduce((couples, reader) => {
                const existingCouple = couples.find(c => c.coupleId === reader.coupleId);
                if (existingCouple) {
                  existingCouple.members.push(reader);
                } else {
                  couples.push({ coupleId: reader.coupleId, members: [reader] });
                }
                return couples;
              }, [])
              .map(couple => (
                <div key={couple.coupleId} className="flex justify-between items-center">
                  <span>{couple.members.map(m => m.name).join(' & ')}</span>
                  <span className="text-blue-600">
                    {couple.members.reduce((sum, m) => sum + m.serviceCount, 0)}회
                  </span>
                </div>
              ))}
          </div>
        </div>
      </div>

      {/* 모달 폼들 */}
      {showMassForm && <MassForm />}
      {showReaderForm && <ReaderForm />}
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50">
      {/* 헤더 */}
      <header className="bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex justify-between items-center">
            <h1 className="text-2xl font-bold text-gray-900">성당 독서단 관리 시스템</h1>
            <div className="flex items-center gap-4">
              <span className="text-gray-600">{currentUser.name}</span>
              <select 
                value={currentUser.role} 
                onChange={(e) => setCurrentUser({...currentUser, role: e.target.value})}
                className="border rounded px-3 py-1"
              >
                <option value="admin">관리자</option>
                <option value="reader">독서단원</option>
              </select>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex gap-6">
          {/* 사이드바 */}
          <div className="w-64 bg-white rounded-lg shadow-sm p-4">
            <nav className="space-y-2">
              <button
                onClick={() => setActiveTab('schedule')}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left ${
                  activeTab === 'schedule' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                }`}
              >
                <Calendar size={20} />
                일정 관리
              </button>
              
              {currentUser.role === 'admin' && (
                <>
                  <button
                    onClick={() => setActiveTab('masses')}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left ${
                      activeTab === 'masses' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Clock size={20} />
                    미사 일정
                  </button>
                  
                  <button
                    onClick={() => setActiveTab('readers')}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left ${
                      activeTab === 'readers' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Users size={20} />
                    독서단원
                  </button>
                </>
              )}
              
              <button
                onClick={() => setActiveTab('unavailability')}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left ${
                  activeTab === 'unavailability' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                }`}
              >
                <X size={20} />
                불가능 시간
              </button>
              
              <button
                onClick={() => setActiveTab('statistics')}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left ${
                  activeTab === 'statistics' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'
                }`}
              >
                <BarChart3 size={20} />
                통계
              </button>
            </nav>

            {currentUser.role === 'admin' && (
              <div className="mt-6 pt-4 border-t">
                <button
                  onClick={autoAssignReaders}
                  className="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-medium"
                >
                  자동 배정 실행
                </button>
              </div>
            )}
          </div>

          {/* 메인 콘텐츠 */}
          <div className="flex-1">
            {activeTab === 'schedule' && (
              <div className="bg-white rounded-lg shadow-sm">
                <div className="p-6 border-b">
                  <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold">
                      {currentDate.getFullYear()}년 {currentDate.getMonth() + 1}월 일정
                    </h2>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}
                        className="p-2 hover:bg-gray-100 rounded"
                      >
                        <ChevronLeft size={20} />
                      </button>
                      <button
                        onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}
                        className="p-2 hover:bg-gray-100 rounded"
                      >
                        <ChevronRight size={20} />
                      </button>
                    </div>
                  </div>
                </div>
                
                <div className="p-6">
                  <div className="grid grid-cols-7 gap-1">
                    {renderCalendar()}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'masses' && currentUser.role === 'admin' && (
              <div className="bg-white rounded-lg shadow-sm p-6">
                <MassScheduleManager />
              </div>
            )}

            {activeTab === 'readers' && currentUser.role === 'admin' && (
              <div className="bg-white rounded-lg shadow-sm p-6">
                <ReaderManager />
              </div>
            )}

            {activeTab === 'unavailability' && (
              <div className="bg-white rounded-lg shadow-sm p-6">
                <UnavailabilityInput />
              </div>
            )}

            {activeTab === 'statistics' && (
              <div className="bg-white rounded-lg shadow-sm p-6">
                <Statistics />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default CatholicReaderSystem;